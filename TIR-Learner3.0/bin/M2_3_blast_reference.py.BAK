import os
import subprocess
import multiprocessing as mp

# from typing import TYPE_CHECKING
# if TYPE_CHECKING:
#     from main import TIRLearner

import prog_const
spliter = prog_const.spliter
TIR_types = prog_const.TIR_types
path = prog_const.program_root_dir


def blast_reference(file_name, refLib, path):
    subject = os.path.join(path, "RefLib", refLib)
    # subject = path + "/RefLib/" + refLib
    out = file_name + spliter + "blast" + spliter + refLib
    blast = (f"blastn -max_hsps 5 -perc_identity 80 -qcov_hsp_perc 80 -query \"{file_name}\" -subject \"{subject}\" "
             "-outfmt '6 qseqid sseqid length pident gaps mismatch qstart qend sstart send evalue qcovhsp' "
             f"-out \"{out}\" 2>/dev/null")
    # Find whether there is any predicted TIR (GRFmite) inside the refLib
    subprocess.Popen(blast, shell=True).wait()


def execute(TIRLearner_instance):
    print("Module 2, Step 3: GRF result blast reference sequences")
    ref_list = [f"{TIRLearner_instance.species}_{TIR_type}_RefLib" for TIR_type in TIR_types]
    mp_args_list = [(TIRLearner_instance.processedGRFmite_file, ref, path) for ref in ref_list]

    with mp.Pool(int(TIRLearner_instance.cpu_cores)) as pool:
        pool.starmap(blast_reference, mp_args_list)
